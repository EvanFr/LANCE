{
    "id": "2b202925-5260-47e2-9cbb-ebe41200234b",
    "created_at": "2023-05-06T02:08:30.155942Z",
    "updated_at": "2024-11-22T02:03:36.475023Z",
    "deleted_at": null,
    "sha1_hash": "010ee45b424cf72374cf7c41e9f9de6b9c2ff4ae",
    "title": "2023-03-09 - BatLoader Continues to Abuse Google Search Ads to Deliver Vidar Stealer and Ursnif",
    "authors": "",
    "file_creation_date": "2023-05-05T02:06:07Z",
    "file_modification_date": "2023-05-05T02:06:07Z",
    "file_size": 3822021,
    "plain_text": "BatLoader Continues to Abuse Google Search Ads to\nDeliver\u2026\nesentire.com/blog/batloader-continues-to-abuse-google-search-ads-to-deliver-vidar-stealer-and-ursnif\n\nPartners\nPARTNER PROGRAM\ne3 Ecosystem\nWe provide sophisticated cybersecurity solutions for Managed Security Service Providers\n(MSSPs), Managed Service Providers (MSPs), and Value-Added Resellers (VARs). Find out\nwhy you should partner with eSentire, the Authority in Managed Detection and Response,\ntoday.\nLearn more\nAdversaries don\u2019t work 9-5 and neither do we. At eSentire, our 24/7 SOCs are staffed with\nElite Threat Hunters and Cyber Analysts who hunt, investigate, contain and respond to\nthreats within minutes.\nWe have discovered some of the most dangerous threats and nation state attacks in our\nspace \u2013 including the Kaseya MSP breach and the more_eggs malware.\nOur Security Operations Centers are supported with Threat Intelligence, Tactical Threat\nResponse and Advanced Threat Analytics driven by our Threat Response Unit \u2013 the TRU\nteam.\nIn TRU Positives, eSentire\u2019s Threat Response Unit (TRU) provides a summary of a recent\nthreat investigation. We outline how we responded to the confirmed threat and what\nrecommendations we have going forward.\nHere\u2019s the latest from our TRU Team\u2026\n\nWhat did we find?\nIn December, we published a summary of BatLoader activity whereby Google Search Ads\nwere used to impersonate software such as WinRAR to deliver malicious Windows Installer\nfiles. The installer files contained custom action commands which used PowerShell to\ndownload and execute payloads (Redline Stealer, Ursnif, etc.) hosted on legitimate websites.\nThroughout February 2023, TRU has observed a series of newly registered websites\nimpersonating various applications and brands. Included among these are:\n\n1/12\n\nChatGPT (chatgpt-t[.]com)\nZoom (zoomvideor[.]com)\nSpotify (spotify-uss[.]com)\nTableau (tableau-r[.]com)\nAdobe (adobe-l[.]com)\nIn addition to comparable domain registration attributes, these websites tend to follow a\nsimilar naming convention where one or more characters are appended to the impersonated\nbrand name (e.g., adobe-l[.]com vs adobe.com). These sites were used to host imposter\ndownload pages and all likely stem from malicious advertisements on Google Search Ads. A\nmore complete list can be found at the end of this post.\nBatLoader continues to see changes and improvement since it first emerged in 2022. Recent\nsamples analyzed by TRU utilize Windows Installer files masquerading as the above\napplications to launch embedded Python scripts.\n\nBatLoader's Python Loader\nIn mid-February 2023, eSentire MDR for Endpoint blocked an attempt to execute Ursnif via\ncode injection on a manufacturing customer\u2019s endpoint. A subsequent investigation traced\nthe infection to a Google search result for Adobe Reader by the victim user.\nThe user had clicked on a top-of-page ad on the search results page where they were\ndirected via an intermediary website (adolbe[.]website) to adobe-e[.]com, a webpage\nmasquerading as Adobe Acrobat Reader (Figure 1). As a result, the user unknowingly\ndownloaded and executed AdobeSetup.msi(9ebbe0a1b79e6f13bfca014f878ddeec),\nBatLoader\u2019s Windows Installer file.\n\nFigure 1 adobe-e[.]com, Adobe Acrobat Reader lookalike webpage.\nLike previous versions of BatLoader, the MSI file contains Custom Actions to execute\ncommands. In this case, the command executed an embedded batch file (seen here as\nInstallPython.bat, also observed as PythonFramework.bat) with admin privileges in a hidden\n\n2/12\n\nwindow.\nA decoy application was written to C:\\Program Files (x86)\\Chat Mapper along with BatLoader\nscripts and supporting files (Figure 2).\n\nFigure 2 BatLoader Python scripts and supporting files.\nThe batch file (figure 3, insert) performs the following actions:\n1. Installs Python 3.9.9 using an included setup binary.\n2. Uses pip to install pywin32 and wmi packages.\n3. Unpacks the compressed OpenSSL library files using PowerShell into multiple\nlocations.\n4. Starts two Python files in sequence after a short timeout.\n\nFigure 3 Batch file execution via Windows Installer custom action.\n\nBatLoader's Python Files\n\n3/12\n\nIn this case, two Python files (framework.py and frameworkb.py) were included in the\npackage. These were protected using PyArmor and require unpacking with tools such as\nPyArmor-Unpacker (Figure 4). The files use a script copied from a Stack Overflow question\nas a template for executing Python code with elevated privileges.\n\nFigure 4 Decoded Python Loader \u201cframework.py\u201d\nBatLoader\u2019s instruction set is inserted into the main function of the Stack Overflow Python\nscript. The code retrieves an encrypted payload as control.exe.enc then executes a series of\nWindows commands. The instructions executed by both Python files were nearly identical\nexcept for a change in the payload URL.\nThe commands shown in Figure 5 are summarized as follows:\n1. Download encrypted payload control.exe.enc from https://shvarcnegerhistory[.]com/\nThe payload is saved under %appdata% or %userprofile%.\n2. Modify Defender settings to exclude paths, processes, and file extensions.\n3. Decrypt control.exe.enc using the OpenSSL library installed by the previous batch file.\nThe password tor9232jds is used and the file is saved as control.exe.\n4. WorkFolders.exe is called, leveraging a signed execution LOLBAS technique to\nexecute control.exe.\n\n4/12\n\nFigure 5 Windows commands from \u201cframework.py\u201d and \u201cframeworkb.py\u201d, summarized\nIn the above-mentioned case, the payload intercepted by MDR for Endpoint was Ursnif\n(md5hash 0cb75b1192b23b8e03d955f1156ad19e), specifically isfb_v2.14+ variant\nconfigured to connect to the following C2 domains:\nuelcoskdi[.]ru\niujdhsndjfks[.]ru\nisoridkf[.]ru\ngameindikdowd[.]ru\njhgfdlkjhaoiu[.]su\nreggy506[.]ru\nreggy914[.]ru\n\n5/12\n\nUrsnif\u2019s persistence was achieved using a registry run key (VirtualStop) under\nHKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run. This value\nexecuted a shortcut (LineType.lnk) which in turn launches a PowerShell script\n(CharReturn.ps1), as seen in Figure 6.\n\nFigure 6 CharReturn.ps1\nCharReturn.ps1 executed a staged PowerShell loader from registry at\nHKEY_USERS\\Software\\AppDataLow\\Software\\Microsoft\\[randomstring]. The loader\ncontained the embedded Ursnif binary which is injected into the Explorer process.\nIn this incident, MDR for Endpoint identified and blocked PowerShell execution of the Ursnif\nloader stored in registry.\n\nOther Batloader Observations\nObserved URL structures would suggest multiple payloads are available for download:\n/t1s1j1/index/c1/?servername=msi\n/t1s1j1/index/c2/?servername=msi\n/t1s1j1/index/c3/?servername=msi\n/t1s1j1/index/c4/?servername=msi\n/t1s1j1/index/b1/?servername=msi\nBatLoader has historically been linked to payloads such as Redline Stealer, SystemBC RAT,\nSyncro RMM, Vidar Stealer, Ursnif and Cobalt Strike. Analysis of more recent samples in\nMarch 2023 has yielded both Vidar Stealer and Ursnif trojans.\nTRU has reviewed samples from public malware repositories which exhibited slightly\ndifferent behavior than what was seen in the February incident described above. This sample\nfrom mid-February contained a third Python file named \u2018networkframework.py\u2019:\n\n6/12\n\nFigure 7 BatLoader's batch file containing a third Python file \"networkframework.py\"\nLike the others, it is obfuscated with PyArmor and contains an identical series of commands\nto handle payload retrieval, decryption and execution via WorkFolder.exe. In addition,\nnetframework.py contains checks for curating payloads for domain-joined systems with more\nthan 2 IP neighbors in the system\u2019s ARP table.\n\nFigure 8 Snippet of BatLoader Python script showing system profiling.\nThis behavior has been previously observed whereby BatLoader executed Cobalt Strike in\naddition to the standard payloads such as Ursnif or Vidar. We assess this is done to prep\nsystems residing in business networks for further infiltration.\nAs of time of writing, the payload URLs were no longer available for retrieval, but given that\nthis fits into BatLoader\u2019s known historical target selection patterns, we assess that Cobalt\nStrike is the probable candidate.\n\nHow did we find it?\neSentire MDR for Endpoint identified and blocked BatLoader\u2019s payload execution.\n\n7/12\n\nWhat did we do?\nOur team of 24/7 SOC Cyber Analysts investigated the blocked behavior and worked\nwith the customer on remediating the system.\n\nWhat can you learn from this TRU positive?\nUse of Google Search Ads by various malware families has been widely observed in\nearly 2023. We wrote about this tactic in a previous TRU Positive post.\nDespite overall observations diminishing in February 2023, BatLoader\u2019s use\ncontinues to persist. This assertion is supported by observations in our own\ntelemetry but also by the continued registration of website infrastructure\nthroughout the month of February.\nBatLoader targets various popular applications for impersonation, such as ChatGPT,\nZoom, Adobe, AnyDesk, Microsoft Teams, Java, etc. This is no accident, as these\napplications are commonly found in business networks and thus, they would yield more\nvaluable footholds for monetization via fraud or hands-on-keyboard intrusions.\nCobalt Strike, a known BatLoader payload, enables hands-on-keyboard access to\nfootholds and facilitates network intrusion actions. BatLoader should be considered a\nprecursor threat to ransomware and any observation prioritized for treatment.\nA November 2022 report by Microsoft linked Royal Ransomware to BatLoader.\n\nRecommendations from our Threat Response Unit (TRU) Team:\nRaise awareness of malware masquerading as legitimate applications, and include\nrelevant examples within your Phishing and Security Awareness Training (PSAT)\nprogram to educate your employees on how to protect themselves against similar\ncyber threats.\nRemember \u2013 an effective PSAT program emphasizes building cyber resilience by\nincreasing risk awareness, rather than trying to turn everyone into security\nexperts.\nProtect endpoints against malware.\nEnsure antivirus signatures are up-to-date.\nUse a Next-Gen AV (NGAV) or Endpoint Detection and Response (EDR) product\nto detect and contain threats.\n\nIndicators of Compromise\nSuspected BatLoader Domains Registered in February 2023:\nDomain\n\nCreation Date\n\nchatgpt-t[.]com\n\n2023-02-28\n8/12\n\nzoomvideor[.]com\n\n2023-02-27\n\nadobe-l[.]com\n\n2023-02-22\n\nfreecad-l[.]com\n\n2023-02-22\n\nmicroso-t[.]com\n\n2023-02-22\n\nspotify-uss[.]com\n\n2023-02-21\n\nquickbooks-q[.]com\n\n2023-02-21\n\nfreecad-f[.]com2\n\n2023-02-20\n\njava-s[.]com\n\n2023-02-13\n\nadobe-e[.]com\n\n2023-02-13\n\nanydesk-o[.]com\n\n2023-02-13\n\nanydesk-r[.]com\n\n2023-02-09\n\njava-r[.]com\n\n2023-02-09\n\ntableau-r[.]com\n\n2023-02-09\n\njava-a[.]com\n\n2023-02-07\n\nbasecamp-a[.]com\n\n2023-02-07\n\nadobe-a[.]com\n\n2023-02-03\n\nvisualstudio-t[.]com\n\n2023-02-03\n\nopenoffice-a[.]com\n\n2023-02-03\n\nbitwarden-t[.]com\n\n2023-02-01\n\ngimp-t[.]com\n\n2023-02-01\n\nfigma-t[.]com6\n\n2023-02-01\n\nOther Indicators of Compromise\nIndicator\n\nNote\n\n3db1edc5b5550f54abdcb5520cf91d75\n\nVidar\n\n0cb75b1192b23b8e03d955f1156ad19e\n\nUrsnif\n\n9/12\n\n85fbc743bb686688ce05cf3289507bf7\n\nUrsnif\n\n11ae3dabdb2d2458da43558f36114acb\n\nAdobeSetup.msi (BatLoader)\n\n9ebbe0a1b79e6f13bfca014f878ddeec\n\nAdobeSetup.msi (BatLoader)\n\nshvarcnegerhistory[.]com\n\nBatLoader C2\n\nPixelarmada[.]su\n\nBatLoader C2\n\nuelcoskdi[.]ru\n\nUrsnif C2\n\niujdhsndjfks[.]ru\nisoridkf[.]ru\ngameindikdowd[.]ru\njhgfdlkjhaoiu[.]su\nreggy506[.]ru\nreggy914[.]ru\neSentire\u2019s Threat Response Unit (TRU) is a world-class team of threat researchers who\ndevelop new detections enriched by original threat intelligence and leverage new machine\nlearning models that correlate multi-signal data and automate rapid response to advanced\nthreats.\nIf you are not currently engaged with an MDR provider, eSentire MDR can help you reclaim\nthe advantage and put your business ahead of disruption.\nLearn what it means to have an elite team of Threat Hunters and Researchers that works for\nyou. Connect with an eSentire Security Specialist.\n\n10/12\n\neSentire Threat Response Unit (TRU)\n\nOur industry-renowned Threat Response Unit (TRU) is an elite team of threat hunters and\nresearchers, that supports our 24/7 Security Operations Centers (SOCs), builds detection\nmodels across our Atlas XDR Cloud Platform, and works as an extension of your security\nteam to continuously improve our Managed Detection and Response service. TRU has been\nrecognized for its threat hunting, original research and content development capabilities.\nTRU is strategically organized into cross-functional groups to protect you against advanced\nand emerging threats, allowing your organization to gain leading threat intelligence and\nincredible cybersecurity acumen.\n\n11/12\n\nCookies allow us to deliver the best possible experience for you on our website - by\ncontinuing to use our website or by closing this box, you are consenting to our use of\ncookies. Visit our Privacy Policy to learn more.\nAccept\n\n12/12",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-03-09 - BatLoader Continues to Abuse Google Search Ads to Deliver Vidar Stealer and Ursnif.pdf"
    ],
    "report_names": [
        "2023-03-09 - BatLoader Continues to Abuse Google Search Ads to Deliver Vidar Stealer and Ursnif.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1683338910155,
    "ts_updated_at": 1732241016475,
    "ts_creation_date": 1683252367000,
    "ts_modification_date": 1683252367000,
    "files": {
        "pdf": "https://archive.orkl.eu/010ee45b424cf72374cf7c41e9f9de6b9c2ff4ae.pdf",
        "text": "https://archive.orkl.eu/010ee45b424cf72374cf7c41e9f9de6b9c2ff4ae.txt",
        "img": "https://archive.orkl.eu/010ee45b424cf72374cf7c41e9f9de6b9c2ff4ae.jpg"
    }
}